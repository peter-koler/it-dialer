# IT-Dialer 多租户 SRS（软件需求规格说明书）
## 1. 引言
### 1.1 目的
本软件需求规格说明书（SRS）定义了 IT-Dialer 系统从单租户架构向多租户架构的改造需求。IT-Dialer 是一个网络拨测系统，用于监控网络连接状态和性能，支持多种拨测任务（ping、TCP、HTTP、API 多步骤事务）、实时监控、数据分析、节点管理、系统变量管理和告警配置。主要模块包括拨测任务管理、报表、节点管理、系统变量管理、告警管理和 Agent 集成。
本 SRS 基于现有设计方案（“多租户.txt”）和系统文档（“README.md”），遵循 SaaS 多租户最佳实践，确保数据隔离、资源控制、安全性和可扩展性。目标是打造一个支持免费和付费订阅的 SaaS 平台，保证每个租户的任务、结果、报表、变量和告警数据完全隔离，复用现有技术栈（Flask、SQLAlchemy、JWT、Vue.js、Pinia、ECharts、Leaflet），最大程度减少架构改动。
#### 1.1.1 改造目标
- **数据完全隔离**：确保每个租户的数据（任务、结果、报表等）相互独立，防止交叉访问。
- **资源配额管理**：基于订阅级别（如 free/pro/enterprise）限制任务、节点等资源。
- **最小化改动**：复用现有 Flask、SQLAlchemy、Vue.js 等组件，渐进式改造。
- **可扩展性**：支持未来功能扩展（如 API 调用率限制）和大规模部署（1000+ 租户）。

#### 1.1.2 核心原则
1. **逻辑隔离优先**：通过 tenant_id 字段实现数据隔离，避免物理隔离的运维复杂性。
2. **向后兼容**：现有数据迁移至默认租户，确保现有功能无缝运行。
3. **渐进式改造**：分阶段实施，优先核心功能（如任务隔离、限额控制）。
4. **性能优先**：确保多租户过滤不显著影响查询效率，优化大数据场景。
### 1.2 范围
- **纳入范围**：
  - 数据库 schema 修改，添加 tenant_id 实现逻辑隔离。
  - 认证授权增强，JWT 携带租户上下文和角色信息。
  - 资源控制，以任务数量限额为主，可扩展至节点、变量、告警等。
  - API 接口调整，自动附加 tenant_id 过滤，支持 super_admin 跨租户操作。
  - 用户界面优化，包括租户选择、资源限额可视化、模块交互（拨测、报表等）。
  - Agent 集成调整，确保任务执行和结果上报的租户隔离。
  - 模块支持：拨测任务（多协议、多步骤 API、变量引用、断言）、报表（趋势图、地域分析）、节点管理、系统变量（$public_ 共享）、告警规则。
- **排除范围**：
  - 物理数据库隔离（优先逻辑隔离，未来可扩展）。
  - 支付系统（如 Stripe）详细实现，仅定义接口。
  - 租户间数据迁移工具的实现细节（仅提供迁移框架）。
  - 插件开发具体实现（但确保插件兼容多租户）。
- **系统边界**：
  - **后端**：Python 3.8+、Flask、SQLAlchemy、MySQL 8.x、JWT、APScheduler。
  - **前端**：Vue 3、Ant Design Vue 4.x、Pinia、Vue Router 4、ECharts、Leaflet。
  - **Agent**：Python，支持插件化扩展，配置通过 agent_config.json。
  - **部署**：Docker-compose，支持云环境（如 AWS）。

### 1.3 定义、缩写和术语
- **租户 (Tenant)**：一个组织或用户组的独立逻辑空间。
- **拨测**：网络测试功能，支持 ping、TCP、HTTP、API 多步骤事务。
- **报表**：基于结果数据的可视化分析，包括趋势图、地域聚合（如省市分析）。
- **Agent**：执行拨测任务的节点，支持插件（如 api.py、http_plugin.py、ping.py、tcp.py）。
- **系统变量**：可引用的配置参数，支持加密（is_secret）和作用域（$public_ 跨租户共享）。
- **告警**：基于断言或指标触发的通知，支持历史查询。
- **SaaS**：软件即服务，多租户软件交付模式。
- **JWT**：JSON Web Token，用于认证。
- **RLS**：行级安全（Row-Level Security，可选增强隔离）。
- **SRS**：软件需求规格说明书。

### 1.4 参考文档

- SaaS 最佳实践：AWS Well-Architected Framework for SaaS、Microsoft Azure 多租户模式。
- 数据库设计模式：共享数据库 + tenant_id 过滤模型。
### 1.5 概述
本 SRS 分为以下部分：
- **总体描述**：提供系统高层视角，包括架构、功能和用户特征。
- **具体需求**：详细定义功能需求（认证、拨测、报表等）、非功能需求（性能、安全性）和接口规范。
- **支持信息**：包括用例图、风险分析、验收标准等。
## 2. 总体描述
### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                         租户层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 租户 A   │  │ 租户 B   │  │ 租户 C   │  │   ...    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   认证授权层       │
                    │  (JWT + tenant_id) │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────┴─────────────────────────────┐
│                      应用服务层                           │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐        │
│  │拨测任务 │  │  报表  │  │节点管理 │  │  告警  │        │
│  └────────┘  └────────┘  └────────┘  └────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │    数据访问层      │
                    │ (自动 tenant_id    │
                    │     过滤)          │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │      数据库        │
                    │   (MySQL 8.x)      │
                    └───────────────────┘
```
### 2.2 产品视角
IT-Dialer 当前为单租户系统，服务单一组织，支持多协议拨测（ping、TCP、HTTP、API）、实时监控、数据分析和 Agent 执行。多租户改造将其升级为 SaaS 平台，允许多个租户共享基础设施，同时确保数据隔离（任务、报表、节点等）。改造复用现有组件（API、插件、Vue.js UI），采用渐进式开发，未来支持扩展资源限制（如 API 调用率）和订阅模型。
### 2.3 产品功能
- **数据隔离**：通过 tenant_id 隔离任务、结果、报表、节点、变量和告警。
- **资源控制**：任务数量限额（max_tasks），可扩展至节点（max_nodes）、变量（max_variables）、告警（max_alerts）。
- **认证授权**：JWT 携带租户上下文，支持角色（tenant_admin、super_admin）。
- **用户界面**：响应式 UI，支持租户选择、限额可视化、模块交互（拨测、报表、节点管理等）。
- **拨测模块**：租户隔离的任务创建/执行，支持多协议、多步骤 API、变量引用、断言验证。
- **报表模块**：租户特定的趋势图、地域分析（省市下钻）、多维度筛选。
- **节点管理**：租户共享 Agent 池，支持区域划分（agent_area）。agent 上报信息根据任务配置的租户 id 进行信息上报。
- **系统变量**：隔离变量，$public_ 前缀支持跨租户共享。
- **告警模块**：租户级规则配置和历史查询。
- **管理功能**：租户创建、更新、使用情况监控。
### 2.4 用户类和特征
- **租户用户 (Tenant User)**：普通用户，仅访问本租户数据，创建拨测任务、查看报表、配置告警。
- **租户管理员 (Tenant Admin)**：管理本租户资源（用户、节点、限额监控）。
- **超级管理员 (Super Admin)**：管理所有租户，支持跨租户操作（如全局变量管理）。
- **Agent**：执行租户隔离的任务并上报结果。
### 2.5 操作环境
- **后端**：Python 3.8+、Flask、SQLAlchemy、MySQL 8.x、APScheduler。
- **前端**：Vue 3、Ant Design Vue 4.x、Pinia、Vue Router 4、ECharts（趋势图）、Leaflet（地图可视化）。
- **Agent**：Python，支持插件，配置通过 agent_config.json。
- **部署**：Docker-compose，支持云环境（如 AWS）。
- **浏览器**：Chrome、Firefox 等现代浏览器。
### 2.6 设计和实现约束
- 采用共享数据库 + tenant_id 逻辑隔离，降低运维复杂性。
- 所有查询自动附加 tenant_id 过滤（通过 SQLAlchemy 过滤器）。
- 支持软删除（status='deleted' 不计入限额，保留历史数据）。
- 扩展 JWT，payload 包含 tenant_id 和 role。
- Agent 配置添加 tenant_id，支持专用或共享 Agent 池。
- 插件兼容多租户，任务配置包含 tenant_id。
- UI 使用 Pinia 管理 tenant_id，保持响应式设计，遵循 Ant Design Vue 规范。
### 2.7 假设和依赖
- 现有数据不需要迁移
- 未来支持支付系统（如 Stripe）动态调整限额。
- 系统规模中等（<1000 租户），超大规模需数据库分区。
- Agent 插件接口不变，执行上下文携带 tenant_id。
- 前端依赖 Pinia 管理状态，Ant Design Vue 提供 UI 组件。
## 3. 具体需求
## 3.2 外部接口需求
#### 3.2.1 用户接口
用户界面基于 Vue 3、Ant Design Vue 4.x、Pinia 和 Vue Router 4，打造响应式 Web 应用，支持租户隔离的交互和可视化。所有 UI 组件按 tenant_id 过滤数据，确保数据安全和隔离。
- **UI-1.1**：租户选择（高优先级）
  - **输入**：用户登录凭证；多租户用户通过 API 获取可用租户列表（GET /api/v1/tenants）。
  - **输出**：登录后，顶部导航栏显示 Ant Design Vue Select 下拉框，列出用户关联的租户名称（单租户用户自动选择）。Pinia 存储选中的 tenant_id。
  - **交互**：
    - 选择租户后，触发 Pinia 状态更新，重定向至仪表板，加载租户特定数据（任务、报表等）。
    - tenant_id 存储在 localStorage，确保页面刷新后保持选择。
    - super_admin 可见“所有租户”选项，进入租户管理面板。
  - **异常**：
    - 无关联租户时，显示 Ant Design Vue Alert：“未分配租户，请联系管理员。”
    - API 失败时，显示错误提示并提供“重试”按钮。
  - **设计**：
    - 下拉框位于顶部导航栏，宽度自适应，遵循 Ant Design Vue 主题（支持深色/浅色模式）。
    - 响应式设计，移动端下拉框折叠为抽屉式选择。

- **UI-1.2**：资源限额展示（高）
  - **输入**：通过 API GET /api/v2/tenants/<id>/usage 获取当前租户使用数据（任务、节点、变量、告警）。
  - **输出**：任务创建使用 Ant Design Vue Progress（进度条）或 Statistic（统计卡片），示例：“任务：5/10，节点：3/5”。
  - **交互**：
    - 仪表板显示卡片式限额概览（Ant Design Vue Card）。
    - 任务创建页面实时更新限额（例如，“剩余任务：5”）。
    - 超限时，弹出 Ant Design Vue Modal，提示：“任务数量超限，是否升级订阅？”并提供管理员联系链接或支付页面（未来）。
  - **异常**：
    - API 失败时，显示 Ant Design Vue Alert：“使用数据不可用，请稍后重试。”
    - 超限操作禁用按钮（如任务创建按钮变灰）。
  - **设计**：
    - 进度条颜色编码：<80% 绿色，80-90% 黄色，>90% 红色。
    - 响应式布局，移动端堆叠显示，桌面端并排。

- **UI-1.8**：租户管理（super_admin 专用，中优先级）
  - **输入**：租户创建/更新表单（名称、描述、subscription_level、max_tasks、max_nodes、max_variables、max_alerts）。
  - **输出**：Ant Design Vue Table 显示租户列表（列：ID、名称、订阅级别、状态、使用统计）。编辑表单调整限额。
  - **交互**：
    - 支持分页、状态过滤（active/inactive/suspended）。
    - 点击租户 ID 跳转至租户仪表板（模拟租户用户视图）。
  - **异常**：租户名称不可重复，提示：“租户名称已存在。”
  - **设计**：
    - 通过 Vue Router 守卫限制 super_admin 访问。
    - 响应式表格/表单，状态徽章（active：绿色，suspended：灰色）。
- **UI-1.9**：交互优化（高）
  - **输入**：用户交互（所有页面）。
  - **输出**：
    - 响应式设计，支持移动端（<768px）/桌面端（>1200px）。
    - 租户可配置主题（深色/浅色，存储于 tenants.metadata）。
    - 平滑路由切换（Vue Router，动画过渡）。
  - **交互**：
    - 异步加载显示 Ant Design Vue Spin（加载动画）。
    - 失败请求弹出 Ant Design Vue Modal（错误信息+重试按钮）。
    - 成功操作显示 Ant Design Vue Notification（例如，“任务创建成功”）。
  - **异常**：网络错误提供重试选项，超时 5 秒后提示用户。
  - **设计**：
    - 遵循 Ant Design Vue 设计规范，字体大小、间距一致。
    - 支持未来 i18n 本地化（预留多语言切换入口）。
）。
#### 3.2.4 硬件接口
- 无特定硬件需求。
### 3.3 功能需求
功能需求按模块分组，包含优先级（高/中/低）、输入/输出和异常处理。所有操作自动应用 tenant_id 过滤。
#### 3.3.1 新增 租户管理 二级菜单，具体功能
- **FR-1.1**：创建租户（高）
  - **输入**：名称、描述、subscription_level（free/pro/enterprise）。
  - **输出**：租户 ID，默认限额（free：max_tasks=10，max_nodes=5，max_variables=20，max_alerts=10）。控制任务的创建数
  - **异常**：
    - 仅 super_admin 可操作（403 错误）。
    - 名称重复返回 400 Bad Request：“租户名称已存在。”
  - **API**：POST /api/v1/tenants。
- **FR-1.2**：更新租户（高）
  - **输入**：租户 ID，更新字段（max_tasks、max_nodes、subscription_level 等）。
  - **输出**：更新后的租户信息。
  - **异常**：限额调整需验证订阅级别（400 错误）。
  - **API**：PUT /api/v1/tenants/<id>。
- **FR-1.3**：列出租户（中）
  - **输入**：过滤参数（状态、订阅级别），super_admin 专用。
  - **输出**：租户列表，包含使用统计（任务、节点等）。
  - **异常**：非 super_admin 返回 403。
  - **API**：GET /api/v1/tenants。
- **FR-1.4**：监控租户使用（高）
  - **输入**：租户 ID。
  - **输出**：当前使用 vs. 限额（任务：5/10，节点：3/5）。
  - **异常**：无效租户 ID 返回 404。
  - **API**：GET /api/v1/tenants/<id>/usage。
UI-1.10：用户租户关联管理（高优先级）
输入：用户管理表单（用户 ID、租户 ID、角色：user/tenant_admin/super_admin），通过 Ant Design Vue Form 提供输入。
输出：Ant Design Vue Table 显示用户租户关联列表（列：用户 ID、用户名、租户名称、角色、创建时间）。支持编辑/删除关联。
交互：
租户管理员（tenant_admin）可管理本租户的用户关联，super_admin 可管理所有租户的关联。
表单支持下拉选择租户（GET /api/v2/tenants）和角色，验证用户 ID 有效性。
列表支持过滤（租户、角色、用户名关键词）、分页、排序（默认按创建时间降序）。
删除关联时弹出 Ant Design Vue Modal 确认框：“确定解除用户与租户的关联？”
异常：
用户或租户不存在时，显示 Ant Design Vue Alert：“用户或租户不存在，请检查输入。”
非授权用户（非 tenant_admin 或 super_admin）尝试操作时，显示 403 错误提示。
设计：
响应式表格/表单，移动端表格折叠，表单字段垂直排列。
角色使用徽章（user：蓝色，tenant_admin：绿色，super_admin：紫色）。
#### 3.3.2 认证与授权
- **FR-2.1**：用户登录（高）
  - **输入**：用户名、密码。
  - **输出**：JWT（包含 user_id、tenant_id、role、exp、iat）。
  - **异常**：无效凭证返回 401 Unauthorized。
  - **API**：POST /api/v1/login。
- **FR-2.2**：租户上下文过滤（高）
  - **输入**：每个请求的 JWT。
  - **输出**：SQLAlchemy 查询自动附加 tenant_id 过滤（Tasks.tenant_id == current_tenant_id）。
  - **异常**：tenant_id 不匹配返回 403 Forbidden。
  - **实现**：Flask 中间件验证 JWT 和 tenant_id。
- **FR-2.3**：角色访问控制（高）
  - **输入**：操作请求（API 或 UI）。
  - **输出**：基于 role 允许/拒绝，super_admin 可通过 ?tenant_id= 跨租户访问。
  - **异常**：权限不足返回 403。

#### 3.3.3 资源控制
- **FR-3.1**：任务限额检查（高）
  - **输入**：创建/更新任务请求（POST/PUT /api/v2/tasks）。
  - **输出**：若 count >= max_tasks，拒绝创建（仅检查新任务，启用/禁用不影响）。
  - **异常**：返回 429 Too Many Requests：“任务数量超限。”
- **FR-3.2**：扩展资源限额（中）
  - **输入**：节点、变量、告警等创建请求。
  - **输出**：若超过 max_nodes、max_variables、max_alerts，拒绝。
  - **异常**：返回 429：“资源 <类型> 数量超限。”
- **FR-3.3**：软删除支持（高）
  - **输入**：删除请求（DELETE /api/v2/tasks/<id> 等）。
  - **输出**：标记 status='deleted'，不计入限额，保留历史数据。
  - **异常**：无效 ID 返回 404。
#### 3.3.4 拨测任务管理（Tasks）
    业务逻辑保持不变，增加租户id，租户创建自己的任务
#### 3.3.5 报表模块（Reports）
 业务逻辑保持不变，增加租户处理逻辑
#### 3.3.6 节点管理（Nodes）
   保持不变，增加租户处理逻辑
#### 3.3.7 系统变量管理（System Variables）
   保持不变，只能是超级管理员可以访问，创建的系统变量，所有租户都能使用
#### 3.3.8 告警管理（Alerts）
  业务逻辑不变，增加租户处理逻辑 按照租户告警列表/详情
#### 3.3.9 Agent 集成
 业务逻辑不变，增加租户处理逻辑 

#### 3.3.10 测试
我现在有两个不同的租户的用户 一个是 ceshi1 密码是 123456 ，一个是 ceshi2 密码是 123456 ，超级用户是 superuser 密码是 1Q2W3E
请你根据这个 SRS 里面描述的功能进行前端的页面测试自动化测试，包括登录、创建任务、创建节点、创建系统变量、查看报表功能。
playwright 测试
两个不同的租户的用户 一个是 ceshi1 密码是 123456 ，一个是 ceshi2 密码是 123456 ，超级用户是 superuser 密码是 1Q2W3E， 前端端口是8080，后端服务是 5001
curl -X POST http://localhost:5001/api/v1/auth/login -H "Content-Type: application/json" -d '{"username": "superadmin", "password": "1Q2W3E"}'
# Prompt：告警处理模块扩展（详细版）

你需要在现有的告警处理模块上扩展功能（包括 PING，TCP，HTTP，API）4 种拨测任务，支持 **监测点数量阈值** 和 **连续次数阈值** 的告警逻辑。  
请严格分步执行，不要跳过。每一步需要先说明思路，再输出结果。  
---
## 第一步：分析现有告警逻辑
1. 阅读现有告警处理模块代码，确认告警配置只包含：
   - **条件类型**（如 Ping 状态异常、丢包率大于某值、执行时间大于某值）。  
   - **告警级别**（警告、严重等）。  
   - **启用状态**（是否启用该条规则）。  
2. 现有逻辑为 **单点单次触发**：
   - 如果某个监测点在一次检测中满足条件，就立即触发告警。  
3. 结论：需要扩展为支持 **跨监测点统计** 和 **连续多次统计**。
---
## 第二步：新增配置项设计
在告警配置中，增加以下三个配置字段：
1. **监测点数量阈值（`min_points`）**  
   - 类型：整数  
   - 说明：当同时有 `n` 个及以上监测点满足异常条件时，才触发告警。  
   - 默认值：1（即保持原有逻辑）。  
2. **连续次数阈值（`min_occurrences`）**  
   - 类型：整数  
   - 说明：当某个监测点连续 `n` 次异常时，才触发告警。  
   - 默认值：1（即保持原有逻辑）。  
3. **逻辑模式（`trigger_mode`）**  
   - 类型：枚举（`OR` / `AND`）  
   - OR：只要满足数量阈值 **或** 连续次数阈值，就触发告警。  
   - AND：必须同时满足数量阈值 **和** 连续次数阈值，才触发告警。  
   - 默认值：OR。  
⚠️ 要求：
- 这三个配置需要在 **后端告警配置模型** 和 **前端表单** 中同时支持。  
- 保持向后兼容，若用户未配置，默认行为与原逻辑一致。
---
## 第三步：数据结构与存储设计
1. **后端配置表（alarm_config）** 新增字段：
   - `min_points` (int, default=1)
   - `min_occurrences` (int, default=1)
   - `trigger_mode` (varchar, default='OR')
2. **运行时状态缓存（memory）**  
   每个监测点需要维护：
   - `consecutive_failures`：连续异常次数计数器。  
   - `last_status`：上次检测状态（正常/异常）。  
   - `history`（可选）：保存最近 N 次检测结果用于调试。  
 
## 第四步：告警判定逻辑修改
1. **连续次数逻辑**  
   - 每次检测：  
     - 若异常 → 计数器 +1  
     - 若正常 → 计数器清零  
   - 当 `consecutive_failures >= min_occurrences` 时，认为该点触发告警件。  
2. **监测点数量逻辑**  
   - 每个检测周期结束后：  
     - 统计满足异常条件的监测点数 `error_points`。  
     - 如果 `error_points >= min_points`，认为触发告警条件。  
3. **逻辑模式处理**  
   - OR 模式：只要满足数量阈值或连续次数阈值 → 触发告警。  
   - AND 模式：必须同时满足数量阈值和连续次数阈值 → 触发告警。  
---
## 第五步：告警输出扩展
在告警触发时，增加以下输出字段：
- `trigger_type`：point_count / consecutive / both  
- `trigger_value`：实际触发值（如 3 个监测点异常，或连续 5 次异常）  
- `trigger_mode`：OR / AND  
前端展示：
- 告警详情中显示“触发原因”，如：  
  - **连续 5 次异常**  
  - **3 个监测点同时异常**  
  - **满足数量和连续条件**
---
## 第六步：前端配置界面调整
在“告警配置”表单中增加：
- 输入框：`监测点数量阈值`（默认 1）  
- 输入框：`连续次数阈值`（默认 1）  
- 下拉框：`逻辑模式（OR/AND）`  
⚠️ 确保：
- 输入框只接受正整数，最小值为 1。  
- 配置保存后能正确传到后端。  
- 默认情况下，用户不配置时与旧版本逻辑完全一致。
---
## 第七步：测试与验证用例
请实现单元测试/集成测试，覆盖以下场景：
1. **单点单次异常**  
   - 配置：`min_points=1, min_occurrences=1`  
   - 行为：保持原逻辑 → 立即告警。  
2. **单点多次异常**  
   - 配置：`min_occurrences=3`  
   - 行为：连续 3 次异常才告警，前两次不告警。  
3. **多点同时异常**  
   - 配置：`min_points=2`  
   - 行为：两个监测点同时异常时告警，一个点异常不告警。  
4. **组合模式 OR**  
   - 配置：`min_points=2, min_occurrences=3, trigger_mode=OR`  
   - 行为：满足任一条件即可告警。  
5. **组合模式 AND**  
   - 配置：`min_points=2, min_occurrences=3, trigger_mode=AND`  
   - 行为：必须两个条件都满足才告警。  
6. **回归兼容性**  
   - 配置缺省（`min_points=1, min_occurrences=1`）  
   - 行为：与旧版本完全一致。  
---
⚡ 要求：  
- **不要直接写代码**，请先输出：
  1. 配置项新增说明  
  2. 数据结构设计方案  
  3. 伪代码逻辑描述  
  4. 单元测试用例说明  
  5.用户 ceshi2 密码是 123456   后台服务端口是 5001，前端端口是 8080
- 确认方案后再进行代码实现。  

# Prompt: 改造 Agent 实现混合模式任务执行与服务端同步
你需要帮助我实现 IT 拨测 Agent 的并发改造，目标是从单进程模式优化为 **混合模式**。  
请严格按照以下要求逐步实现代码和功能（包括 Agent 端和服务端的前端部分）。  
我把 agent 的 文件做了一个备份放在 agent_backup目录，在这个过程中，你可以参考原有代码的实现方式
---
## 🎯 功能目标
1. **Agent 主进程**  
   - 负责任务调度、心跳、任务分发。  
   - 上报当前的线程池状态（线程数、正在执行的任务数、等待任务数）。  
   - 接收服务端任务变化（新增、修改、删除、任务间隔调整）。  
   - 根据任务变化，动态调整线程池的任务执行计划。  
2. **任务执行模型**  
   - 使用 **线程池（ThreadPoolExecutor）** 执行拨测任务。  
   - 不使用单纯的 async/await，而是采用同步线程池方式。  
   -不改变插件代码的业务逻辑，例如上报格式等。
3. **心跳与上报**  
   - 心跳包需要新增线程池状态信息：  
     - 最大线程数  
     - 活跃线程数  
     - 已完成任务数  
     - 队列中的等待任务数  
   - 上报接口与服务端对接，便于前端实时展示。  
4. **任务动态管理**  
   - 从服务端获取任务变化时：  
     - 新增任务 → 加入线程池调度。  
     - 删除任务 → 停止该任务，不再调度。  
     - 修改任务（间隔时间、目标对象） → 更新任务调度规则。  
   - 需要保证线程池的任务安全退出，不会出现重复执行或资源泄漏。  
5. **服务端前端同步修改**  
   - 在服务端前端界面增加：  
     - 每个 Agent 的线程池状态展示（线程数、执行任务数）。  
     - 每个任务的执行状态（运行中、等待中、已完成）。  
   - 前端需要支持实时刷新（WebSocket 或轮询）。  
   - 当任务参数被修改时，界面能同步展示最新的调度规则。  
---
## 🛠️ 实现步骤
### 1. Agent 主进程改造
- 增加一个 **任务调度器模块**，统一管理任务 → 线程池映射。  
- 每个任务包含：`task_id, tenant_id, interval, target, config`。  
- 使用 `ThreadPoolExecutor(max_workers=N)` 管理任务执行。  
- 维护一个全局任务字典，用于动态增删改任务。  
- 主进程周期性上报线程池状态。
- 在配置文件增加线程池的配置， 当需要增加的任务超过线程池配置提示超过最大线程
### 2. 心跳包扩展
- 在原有心跳接口 `/api/v1/nodes/heartbeat` 增加线程池信息：  
  ```json
  {
    "agent_id": "xxx",
    "status": "running",
    "thread_pool": {
      "max_workers": 20,
      "active_threads": 5,
      "completed_tasks": 120,
      "pending_tasks": 10
    }
  }
3. 动态任务管理
主进程监听任务变更 API：GET /api/v1/tasks/agent?agent_id={id}
对比现有任务字典，决定是否新增、更新或删除任务。
修改时：
更新任务间隔，重启调度。
任务对象变化时，更新执行逻辑。
确保线程安全，避免同时修改导致异常。
4. 执行任务线程池
每个任务按间隔时间提交给线程池。
在线程池内部，调用对应的插件执行拨测逻辑。
执行完成后，调用 /api/v1/results 上报结果。
异常处理：
单个任务失败不会影响其他任务。
任务执行超时要强制结束。
5. 服务端前端修改
在「节点管理」页面节点列表中新增内容展示：
线程池监控信息（线程数、执行任务数、等待任务数），相关信息由 agent 进行上报
支持实时更新：
当任务被修改/删除时，前端立即刷新界面，确保状态一致。
6.- 日志模块改造（新增要求）
- 使用统一的日志模块，主进程和所有子线程/子进程写入同一个日志文件。  
- 日志配置从 `agent_config.json` 读取，支持以下参数：  
  - `log_mode`: 日志模式（INFO / DEBUG / ERROR 等）。  
  - `log_path`: 日志文件保存路径。  
  -`log_name`:xxxlog 日志
  - `log_rotation`: 是否启用按天滚动日志。  
- 如果启用 `log_rotation: true`，日志文件应按日期生成，例如：
log_name.2025.09.04.log
log_name./2025.09.05.log
日志内容至少包含以下事件：  
- **任务新增**：`[INFO] 新增任务 task_id=xxx, interval=60s, tenant=abc`  
- **任务修改**：`[INFO] 修改任务 task_id=xxx, 新间隔=120s`  
- **任务删除**：`[INFO] 删除任务 task_id=xxx`  
- **任务失败**：`[ERROR] 任务执行失败 task_id=xxx, error=xxxxx`  
- **线程池状态**：`[DEBUG] 当前线程池 active=5, pending=10, completed=100`  
- 日志必须支持 **线程安全写入**，避免多线程同时写日志导致混乱。 
⚠️ 需要考虑的边界情况
任务执行超时：必须加超时机制，避免线程池卡死。
任务更新冲突：如果正在运行，更新操作应等任务完成后生效。
任务删除：确保已提交但未执行的任务可以安全取消。
心跳丢失：前端需要展示「Agent 离线」状态。
租户隔离：任务和结果上报必须带上 tenant_id。
线程池过载：如果提交任务过多，应有队列上限和丢弃策略。
✅ 输出要求
请在编码过程中：
严格遵守现有 Agent 架构（插件化、REST API 交互、多租户）。
保证代码模块化，调度逻辑与插件逻辑解耦。
提供必要的日志，便于调试（任务新增、修改、删除、失败）。
完成后输出详细的修改说明，包括：
Agent 端改造点
服务端 API 改造点
前端 UI 改造点
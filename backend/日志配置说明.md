# 后端服务日志配置说明

## 概述

后端服务现在支持统一的日志配置功能，可以通过配置文件设置日志输出文件和日志级别。所有的代码文件都会统一输出到指定的日志文件中。

## 配置文件

### logging.conf

主要的日志配置文件，位于 `backend/logging.conf`，包含以下配置项：

```ini
# 日志文件路径
# 如果不设置或设置为空，则只输出到控制台
LOG_FILE=logs/backend.log

# 日志级别
# 可选值: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# 单个日志文件最大大小（字节）
# 默认: 10485760 (10MB)
LOG_MAX_BYTES=10485760

# 保留的日志文件备份数量
# 默认: 5
LOG_BACKUP_COUNT=5
```

## 配置项说明

### LOG_FILE
- **作用**: 指定日志文件的输出路径
- **默认值**: `logs/backend.log`
- **说明**: 
  - 如果设置为空或不设置，日志只会输出到控制台
  - 支持相对路径和绝对路径
  - 如果目录不存在，系统会自动创建

### LOG_LEVEL
- **作用**: 设置日志输出级别
- **默认值**: `INFO`
- **可选值**:
  - `DEBUG`: 输出所有级别的日志（最详细）
  - `INFO`: 输出INFO及以上级别的日志
  - `WARNING`: 输出WARNING及以上级别的日志
  - `ERROR`: 输出ERROR及以上级别的日志
  - `CRITICAL`: 只输出CRITICAL级别的日志（最简洁）

### LOG_MAX_BYTES
- **作用**: 设置单个日志文件的最大大小
- **默认值**: `10485760` (10MB)
- **说明**: 当日志文件达到此大小时，会自动创建新的日志文件

### LOG_BACKUP_COUNT
- **作用**: 设置保留的日志文件备份数量
- **默认值**: `5`
- **说明**: 系统会保留最近的N个日志文件，超出数量的旧文件会被自动删除

## 日志格式

日志输出格式为：
```
%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s
```

示例：
```
2025-08-19 22:52:10 - app.scheduler - INFO - scheduler.py:45 - 定时任务调度器已启动
2025-08-19 22:52:26 - werkzeug - INFO - _internal.py:187 - 127.0.0.1 - - [19/Aug/2025 22:52:26] "GET /api/v1/tasks HTTP/1.1" 200 -
```

## 使用方法

### 1. 修改配置

编辑 `backend/logging.conf` 文件，修改相应的配置项：

```ini
# 示例：设置为DEBUG级别，输出到自定义路径
LOG_FILE=/var/log/it-dialer/backend.log
LOG_LEVEL=DEBUG
LOG_MAX_BYTES=52428800  # 50MB
LOG_BACKUP_COUNT=10
```

### 2. 重启服务

修改配置后，需要重启后端服务使配置生效：

```bash
cd backend
python3 run.py
```

### 3. 环境变量覆盖

也可以通过环境变量来覆盖配置文件中的设置：

```bash
export LOG_FILE="/custom/path/backend.log"
export LOG_LEVEL="DEBUG"
python3 run.py
```

## 日志轮转

系统使用Python的 `RotatingFileHandler` 实现日志轮转：

- 当日志文件大小达到 `LOG_MAX_BYTES` 时，会自动创建新文件
- 旧文件会被重命名为 `backend.log.1`, `backend.log.2` 等
- 系统会保留最近的 `LOG_BACKUP_COUNT` 个文件
- 超出数量的旧文件会被自动删除

## 日志文件位置

默认情况下，日志文件会保存在：
- **相对路径**: `backend/logs/backend.log`
- **绝对路径**: 根据配置文件中的设置

## 故障排除

### 1. 日志文件未创建
- 检查 `LOG_FILE` 配置是否正确
- 确认应用有写入权限
- 查看控制台是否有错误信息

### 2. 日志级别不生效
- 确认 `LOG_LEVEL` 配置值正确（大小写敏感）
- 重启服务使配置生效

### 3. 日志文件过大
- 调整 `LOG_MAX_BYTES` 设置
- 增加 `LOG_BACKUP_COUNT` 数量
- 考虑使用更高的日志级别（如WARNING或ERROR）

## 开发建议

### 1. 开发环境
```ini
LOG_LEVEL=DEBUG
LOG_FILE=logs/backend-dev.log
```

### 2. 生产环境
```ini
LOG_LEVEL=INFO
LOG_FILE=/var/log/it-dialer/backend.log
LOG_MAX_BYTES=52428800  # 50MB
LOG_BACKUP_COUNT=10
```

### 3. 测试环境
```ini
LOG_LEVEL=WARNING
LOG_FILE=logs/backend-test.log
```

## 注意事项

1. 修改配置后必须重启服务才能生效
2. 日志文件路径必须是应用有写入权限的目录
3. 在生产环境中建议使用绝对路径
4. 定期检查日志文件大小，避免占用过多磁盘空间
5. 敏感信息不会被记录到日志中（如密码、密钥等）
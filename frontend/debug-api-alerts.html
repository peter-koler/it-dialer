<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API告警调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .success { background-color: #f6ffed; border-color: #b7eb8f; }
        .error { background-color: #fff2f0; border-color: #ffccc7; }
        .info { background-color: #f0f9ff; border-color: #91d5ff; }
        .warning { background-color: #fffbe6; border-color: #ffe58f; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #1890ff; color: white; }
        .btn-success { background-color: #52c41a; color: white; }
        .btn-warning { background-color: #faad14; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>API告警功能调试</h1>
        
        <div class="section info">
            <h3>调试步骤</h3>
            <button class="btn-primary" onclick="testLogin()">1. 测试登录</button>
            <button class="btn-primary" onclick="testApiAlerts()">2. 测试API告警接口</button>
            <button class="btn-warning" onclick="testFrontendLogic()">3. 测试前端逻辑</button>
            <button class="btn-success" onclick="clearLogs()">清空日志</button>
        </div>

        <div class="section">
            <h3>当前状态</h3>
            <div id="status" class="status info">等待测试...</div>
        </div>

        <div class="section">
            <h3>调试日志</h3>
            <div id="logs"></div>
        </div>

        <div class="section">
            <h3>告警数据表格</h3>
            <div id="alertTable"></div>
        </div>
    </div>

    <script>
        let accessToken = '';
        let tenantId = '';
        let rawApiResponse = null;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `section ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('alertTable').innerHTML = '';
            updateStatus('日志已清空', 'info');
        }

        async function testLogin() {
            try {
                updateStatus('正在登录...', 'warning');
                log('开始测试登录...', 'info');
                
                const response = await fetch('http://localhost:5001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'ceshi2',
                        password: '123456'
                    })
                });

                const data = await response.json();
                log(`登录响应状态: ${response.status}`, 'info');
                log(`登录响应: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');

                if (data.code === 0) {
                    accessToken = data.data.access_token;
                    tenantId = data.data.user.tenant_id;
                    updateStatus('登录成功！', 'success');
                    log('登录成功！', 'success');
                    log(`Token: ${accessToken.substring(0, 50)}...`, 'info');
                    log(`Tenant ID: ${tenantId}`, 'info');
                } else {
                    updateStatus('登录失败', 'error');
                    log('登录失败: ' + data.message, 'error');
                }
            } catch (error) {
                updateStatus('登录请求失败', 'error');
                log('登录请求失败: ' + error.message, 'error');
            }
        }

        async function testApiAlerts() {
            if (!accessToken) {
                updateStatus('请先登录', 'error');
                log('请先登录获取Token', 'error');
                return;
            }

            try {
                updateStatus('正在获取告警数据...', 'warning');
                log('开始测试API告警接口...', 'info');
                
                const url = 'http://localhost:5001/api/v2/api-alerts?page=1&page_size=10';
                log(`请求URL: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Tenant-ID': tenantId,
                        'Content-Type': 'application/json'
                    }
                });

                rawApiResponse = await response.json();
                log(`API响应状态: ${response.status}`, 'info');
                log(`API告警响应: <pre>${JSON.stringify(rawApiResponse, null, 2)}</pre>`, 'info');

                if (rawApiResponse.code === 0) {
                    const alerts = rawApiResponse.data?.list || [];
                    updateStatus(`获取成功: ${alerts.length}/${rawApiResponse.data?.total || 0} 条告警`, 'success');
                    log(`获取到 ${alerts.length} 条告警数据，总计 ${rawApiResponse.data?.total || 0} 条`, 'success');
                    
                    if (alerts.length > 0) {
                        displayAlertsTable(alerts);
                    } else {
                        log('告警列表为空', 'warning');
                    }
                } else {
                    updateStatus('API请求失败', 'error');
                    log('API告警请求失败: ' + rawApiResponse.message, 'error');
                }
            } catch (error) {
                updateStatus('API请求异常', 'error');
                log('API告警请求失败: ' + error.message, 'error');
            }
        }

        function testFrontendLogic() {
            if (!rawApiResponse) {
                log('请先调用API获取数据', 'error');
                return;
            }

            log('开始测试前端数据处理逻辑...', 'info');
            log(`原始响应数据结构: ${typeof rawApiResponse.data}, keys: ${Object.keys(rawApiResponse.data || {}).join(', ')}`, 'info');
            
            // 模拟前端逻辑
            let rawList = [];
            let total = 0;
            
            if (rawApiResponse.data) {
                // 方式1: response.data.data.list
                if (rawApiResponse.data.data && rawApiResponse.data.data.list) {
                    rawList = rawApiResponse.data.data.list;
                    total = rawApiResponse.data.data.total || 0;
                    log('使用数据结构: response.data.data.list', 'success');
                }
                // 方式2: response.data.list
                else if (rawApiResponse.data.list) {
                    rawList = rawApiResponse.data.list;
                    total = rawApiResponse.data.total || 0;
                    log('使用数据结构: response.data.list', 'success');
                }
                // 方式3: 直接是数组
                else if (Array.isArray(rawApiResponse.data)) {
                    rawList = rawApiResponse.data;
                    total = rawApiResponse.data.length;
                    log('使用数据结构: response.data (数组)', 'success');
                }
                else {
                    log('无法识别的数据结构', 'error');
                    log(`数据类型: ${typeof rawApiResponse.data}`, 'error');
                    log(`数据内容: <pre>${JSON.stringify(rawApiResponse.data, null, 2)}</pre>`, 'error');
                }
            }
            
            log(`原始数据长度: ${rawList.length}`, 'info');
            log(`分页总数: ${total}`, 'info');
            
            if (rawList.length > 0) {
                const transformedData = rawList.map((alert, index) => ({
                    id: alert.id || `alert_${index}`,
                    taskName: alert.task_name || alert.title || '未知任务',
                    triggerTime: alert.trigger_time || alert.created_at || '-',
                    level: alert.alert_level,
                    status: alert.status || 'pending',
                    content: alert.content || alert.title || '-'
                }));
                
                log(`转换后数据: <pre>${JSON.stringify(transformedData, null, 2)}</pre>`, 'success');
                displayTransformedTable(transformedData);
            } else {
                log('没有数据可转换', 'warning');
            }
        }

        function displayAlertsTable(alerts) {
            const tableDiv = document.getElementById('alertTable');
            let tableHtml = `
                <h4>原始API数据表格</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>任务名称</th>
                            <th>告警级别</th>
                            <th>状态</th>
                            <th>触发时间</th>
                            <th>内容</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            alerts.forEach((alert, index) => {
                tableHtml += `
                    <tr>
                        <td>${alert.id || `alert_${index}`}</td>
                        <td>${alert.task_name || alert.title || '未知任务'}</td>
                        <td>${alert.alert_level || '-'}</td>
                        <td>${alert.status || 'pending'}</td>
                        <td>${alert.trigger_time || alert.created_at || '-'}</td>
                        <td>${(alert.content || alert.title || '-').substring(0, 50)}...</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            tableDiv.innerHTML = tableHtml;
            log('原始数据表格已生成', 'success');
        }

        function displayTransformedTable(data) {
            const tableDiv = document.getElementById('alertTable');
            let tableHtml = tableDiv.innerHTML + `
                <h4>前端转换后数据表格</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>任务名称</th>
                            <th>告警级别</th>
                            <th>状态</th>
                            <th>触发时间</th>
                            <th>内容</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((alert) => {
                tableHtml += `
                    <tr>
                        <td>${alert.id}</td>
                        <td>${alert.taskName}</td>
                        <td>${alert.level || '-'}</td>
                        <td>${alert.status}</td>
                        <td>${alert.triggerTime}</td>
                        <td>${(alert.content || '-').substring(0, 50)}...</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            tableDiv.innerHTML = tableHtml;
            log('转换后数据表格已生成', 'success');
        }

        // 页面加载时自动开始测试
        window.onload = function() {
            log('页面加载完成，可以开始测试', 'info');
            updateStatus('页面已就绪，请点击按钮开始测试', 'info');
        };
    </script>
</body>
</html>
# API拨测功能测试指南

本文档提供了如何测试API拨测功能的完整流程指南，包括前端界面测试和后端API测试。

## 前提条件

确保以下服务已经启动并正常运行：

1. 后端服务 (Flask)
2. 前端服务 (Vue)
3. 至少一个Agent服务

## 自动化测试脚本

我们提供了一个自动化测试脚本 `test_api_task_flow.py`，它会测试API拨测功能的完整流程：

1. 创建系统变量
2. 创建API拨测任务
3. 执行API拨测任务
4. 查看API拨测结果

### 运行自动化测试

```bash
# 进入测试目录
cd tests

# 运行测试脚本
python test_api_task_flow.py
```

测试脚本会输出每个步骤的执行结果，并在最后给出测试摘要。如果所有步骤都通过，则表示API拨测功能正常工作。

## 手动测试流程

除了自动化测试外，您还可以按照以下步骤手动测试API拨测功能：

### 1. 系统变量管理

1. 登录系统
2. 在左侧菜单中点击「系统管理」>「系统变量」
3. 点击「添加变量」按钮
4. 填写变量信息：
   - 变量名称：`$public_test_api_base_url`
   - 变量值：`https://httpbin.org`
   - 是否保密：否
   - 描述：API测试基础URL
5. 点击「确定」保存变量
6. 验证变量是否显示在列表中

### 2. 创建API拨测任务

1. 在左侧菜单中点击「拨测配置」>「任务配置」
2. 点击「新建任务」按钮
3. 填写基本信息：
   - 任务名称：API拨测测试任务
   - 任务类型：API拨测
   - 目标地址：`$public_test_api_base_url`
   - 执行间隔：60秒
   - 选择执行节点
4. 添加初始化变量：
   - 变量名：`$test_value`
   - 变量值：`test123`
5. 添加步骤1：
   - 步骤名称：获取IP信息
   - 请求方法：GET
   - URL：`$public_test_api_base_url/ip`
   - 添加请求头：
     - Content-Type: application/json
     - User-Agent: IT-Dialer-Test
   - 添加断言：
     - 类型：状态码
     - 目标：status_code
     - 操作符：等于
     - 期望值：200
   - 添加变量提取：
     - 变量名：`$ip`
     - 提取类型：JSON
     - 表达式：`$.origin`
6. 添加步骤2：
   - 步骤名称：发送测试数据
   - 请求方法：POST
   - URL：`$public_test_api_base_url/post`
   - 添加请求头：
     - Content-Type: application/json
     - User-Agent: IT-Dialer-Test
   - 添加请求体：
     ```json
     {
       "test_value": "$test_value",
       "ip": "$ip"
     }
     ```
   - 添加断言：
     - 类型：JSON
     - 目标：`$.json.test_value`
     - 操作符：等于
     - 期望值：`$test_value`
7. 点击「保存」按钮

### 3. 执行API拨测任务

1. 在任务列表中找到刚创建的API拨测任务
2. 点击「立即执行」按钮
3. 等待任务执行完成（约5-10秒）

### 4. 查看API拨测结果

1. 在左侧菜单中点击「任务管理」>「结果列表」
2. 找到刚执行的API拨测任务
3. 点击「详情」按钮
4. 查看API执行结果：
   - 验证任务概览信息是否正确
   - 验证步骤执行结果是否正确
   - 验证变量提取和断言结果是否正确

## 常见问题排查

如果测试过程中遇到问题，请检查以下几点：

1. 确保后端服务、前端服务和Agent服务都已启动
2. 检查Agent是否正常连接到后端服务
3. 检查网络连接是否正常，特别是与httpbin.org的连接
4. 查看后端日志和Agent日志，寻找可能的错误信息
5. 确保系统变量名称格式正确（以$public_开头）

## 测试通过标准

当满足以下条件时，可以认为API拨测功能测试通过：

1. 能够成功创建系统变量
2. 能够成功创建API拨测任务
3. 能够成功执行API拨测任务
4. 能够查看API拨测结果，且结果正确
5. 变量提取和断言功能正常工作